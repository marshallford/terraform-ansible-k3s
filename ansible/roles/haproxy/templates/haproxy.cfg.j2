#jinja2: lstrip_blocks: True
global
  log stdout format raw local0 notice

defaults
  mode tcp
  log global
  option tcplog
  timeout connect 10s
  timeout client 1m
  timeout server 1m
  timeout tunnel 4h

frontend main
  bind fd@3
  default_backend machines

backend machines
  balance leastconn
  default-server inter 5s fall 2 rise 1 check
  {% for server in __haproxy_backend_servers %}
  server {{ server[0] }} {{ (server[0] == inventory_hostname) | ternary('host.containers.internal', server[1]) }}:{{ __haproxy_backend_port }}
  {% endfor %}
